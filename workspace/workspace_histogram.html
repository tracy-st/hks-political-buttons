<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Color Spectrum Histogram</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;margin:16px;background:#fafafa;color:#222}
    h1{margin:0 0 12px}
    .legend{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .spectrum{height:18px;flex:1;border-radius:4px;background:linear-gradient(90deg, red 0deg, orange 45deg, yellow 90deg, green 135deg, cyan 180deg, blue 225deg, purple 270deg, magenta 315deg, red 360deg);box-shadow:0 1px 2px rgba(0,0,0,.08)}
    .controls{margin-bottom:12px}
    .hist-wrap{display:flex;gap:6px;overflow:auto;padding:8px 4px;border-radius:6px;background:#fff;border:1px solid #e6e6e6}
    .bin{width:80px;min-width:60px;border-radius:4px;padding:6px;background:#fff;border:1px solid #eee;display:flex;flex-direction:column;align-items:center}
    .bin .label{font-size:12px;color:#666;margin-bottom:6px;text-align:center}
    .thumbs{display:flex;flex-direction:column;gap:6px;align-items:center;max-height:360px;overflow:auto;width:100%}
    .thumb{width:56px;height:40px;object-fit:cover;border-radius:4px;border:1px solid #ddd;cursor:pointer}
    .count{font-size:12px;color:#333;margin-top:6px}
    .neutral-bin{background:#f7f7f7}
    .meta{margin-top:8px;font-size:13px;color:#444}
    /* modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:999}
    .modal .content{background:#fff;padding:12px;border-radius:6px;max-width:90%;max-height:90%;overflow:auto}
    .modal img{max-width:100%;height:auto;display:block}
    .close{background:#333;color:#fff;border:none;padding:6px 10px;border-radius:4px;cursor:pointer}
  </style>
</head>
<body>
  <h1>Image Thumbnails Across a Color Spectrum</h1>
  <div class="legend">
    <div style="font-size:14px;font-weight:600">Spectrum</div>
    <div class="spectrum"></div>
    <div style="font-size:13px;color:#555">Bins: <select id="binCount"><option>12</option><option selected>24</option><option>36</option><option>72</option></select></div>
  </div>

  <div class="controls">
    <button id="reload">Reload CSV</button>
    <label style="margin-left:12px"><input type="checkbox" id="showCounts" checked> Show counts</label>
  </div>

  <div id="hist" class="hist-wrap" aria-live="polite"></div>
  <div class="meta" id="meta">Loading…</div>

  <div id="modal" class="modal"><div class="content"><button id="closeModal" class="close">Close</button><div id="modalBody"></div></div></div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    // Reads data/color_names.csv, groups rows by image, picks dominant color by proportion,
    // computes hue (0..360) from hex, bins images by hue and renders thumbnails in each bin.

    const CSV = '../data/color_names.csv';
    const histEl = document.getElementById('hist');
    const metaEl = document.getElementById('meta');
    const binSelect = document.getElementById('binCount');
    const reloadBtn = document.getElementById('reload');
    const showCounts = document.getElementById('showCounts');

    reloadBtn.addEventListener('click', build);
    binSelect.addEventListener('change', build);
    showCounts.addEventListener('change', ()=> renderBins(window.bins || []));

    document.getElementById('closeModal').addEventListener('click', ()=>{ document.getElementById('modal').style.display='none'; });

    function normalizeHex(h){ if(!h) return ''; h=h.trim(); if(h[0] !== '#') h='#'+h; if(h.length===4) h='#'+h[1]+h[1]+h[2]+h[2]+h[3]+h[3]; return h.toLowerCase(); }

    function hexToRgb(hex){ if(!hex) return null; hex = hex.replace('#',''); if(hex.length===3) hex = hex.split('').map(c=>c+c).join(''); const n=parseInt(hex,16); return {r:(n>>16)&255, g:(n>>8)&255, b:n&255}; }

    function rgbToHsl(r,g,b){ r/=255;g/=255;b/=255; const max=Math.max(r,g,b), min=Math.min(r,g,b); let h=0,s=0,l=(max+min)/2; if(max!==min){ const d=max-min; s = l>0.5? d/(2-max-min) : d/(max+min); switch(max){ case r: h=(g-b)/d + (g<b?6:0); break; case g: h=(b-r)/d + 2; break; case b: h=(r-g)/d + 4; break; } h/=6; } return {h: h*360, s, l}; }

  function colorDistance(a,b){ if(!a||!b) return Infinity; const dr=a.r-b.r, dg=a.g-b.g, db=a.b-b.b; return Math.sqrt(dr*dr+dg*dg+db*db); }

    // Build image-level objects: { image_url, id, topColor: {hex, proportion, color_name}, colors: [...] }
    function groupImages(rows){
      const by = {};
      rows.forEach(r=>{
        const img = (r.image_url || r.url || '').toString().replace(/^"|"$/g,'');
        if(!img) return;
        if(!by[img]) by[img] = { image_url: img, id: r.id || img, w_cm: r.w_cm || '', colors: [] };
        by[img].colors.push({ hex: normalizeHex(r.color||''), proportion: parseFloat(r.proportion) || 0, color_name: (r.color_name||'').toString().toLowerCase().trim() });
      });
      return Object.keys(by).map(k=>{
        const g = by[k];
        g.colors.sort((a,b)=> b.proportion - a.proportion);
        g.topColor = g.colors[0] || {hex:'',proportion:0,color_name:''};
        return g;
      });
    }

    function build(){
      metaEl.textContent = 'Loading CSV and computing histogram…';
      Papa.parse(CSV, { header:true, download:true, skipEmptyLines:true, complete: (res)=>{
        const imgs = groupImages(res.data);
        // compute hue for each image; if topColor is neutral (low saturation or extreme lightness), mark null
        imgs.forEach(img=>{
          // If the top color is a common image background (e.g. dark gray/brown like #2e2a29),
          // fall back to the second-top color if available before deciding neutral.
          let useColor = img.topColor || {hex:''};
          const bgHex = '#2e2a29';
          const bgRgb = hexToRgb(bgHex);
          const topHex = normalizeHex(useColor.hex||'');
          const topRgb = hexToRgb(topHex);
          if(topRgb && colorDistance(topRgb, bgRgb) <= 28 && img.colors && img.colors.length>1){
            // use second-best color
            useColor = img.colors[1];
          }

          const hex = normalizeHex(useColor.hex || '');
          const rgb = hexToRgb(hex);
          if(!rgb){ img.hue = null; return; }
          const hsl = rgbToHsl(rgb.r,rgb.g,rgb.b);
          // consider neutral if saturation < .08 or lightness < .05 or > .95
          if(hsl.s < 0.08 || hsl.l < 0.05 || hsl.l > 0.95){ img.hue = null; }
          else img.hue = Math.round(hsl.h || 0);
        });

        const binCount = parseInt(binSelect.value,10) || 24;
        // Create bins 0..binCount-1 and a neutral bin
        const bins = Array.from({length:binCount},(_,i)=>({idx:i,items:[] }));
        const neutralGroups = { white: [], black: [], neutral: [] };
        imgs.forEach(img=>{
          if(img.hue === null || img.hue === undefined){
            // classify into white/black/neutral by lightness
            // compute HSL for the color we used (top or fallback)
            const hex = normalizeHex((img.topColor && img.topColor.hex) || '');
            const rgb = hexToRgb(hex);
            let hsl = null;
            if(rgb) hsl = rgbToHsl(rgb.r,rgb.g,rgb.b);
            // fallback: if hsl not available, treat as neutral
            if(!hsl){ neutralGroups.neutral.push(img); }
            else if(hsl.l <= 0.12){ neutralGroups.black.push(img); }
            else if(hsl.l >= 0.92){ neutralGroups.white.push(img); }
            else { neutralGroups.neutral.push(img); }
          }
          else{
            const b = Math.floor(img.hue / (360/binCount)) % binCount;
            bins[b].items.push(img);
          }
        });
        window.bins = bins; window.neutralGroups = neutralGroups;
        renderBins(bins, neutralGroups);
        metaEl.textContent = `Images: ${imgs.length} • bins: ${binCount} • white: ${neutralGroups.white.length} • black: ${neutralGroups.black.length} • neutral: ${neutralGroups.neutral.length}`;
      }, error: (err)=>{ metaEl.textContent = 'CSV load error: '+err; }});
    }

    function renderBins(bins, neutralGroups){
      histEl.innerHTML = '';
      const showCount = showCounts.checked;
      bins.forEach((bin, i)=>{
        const binEl = document.createElement('div'); binEl.className='bin';
        const hueStart = Math.round(i*(360/bins.length));
        const hueEnd = Math.round((i+1)*(360/bins.length));
        const lbl = document.createElement('div'); lbl.className='label'; lbl.textContent = `${hueStart}–${hueEnd}°`;
        binEl.appendChild(lbl);
        const thumbs = document.createElement('div'); thumbs.className='thumbs';
        bin.items.forEach(it=>{
          const img = document.createElement('img'); img.className='thumb'; img.src = "../images/" + it.image_url; img.title = `${it.topColor.color_name || ''} ${it.topColor.hex || ''} ${Math.round((it.topColor.proportion||0)*100)}%`;
          img.addEventListener('click', ()=> openModal(it));
          thumbs.appendChild(img);
        });
        binEl.appendChild(thumbs);
        if(showCount){ const cnt = document.createElement('div'); cnt.className='count'; cnt.textContent = bin.items.length; binEl.appendChild(cnt); }
        histEl.appendChild(binEl);
      });
      // neutral groups at the end: white, neutral (gray), black
      const makeNeutralBin = (label, items) => {
        const nb = document.createElement('div'); nb.className='bin neutral-bin';
        const nl = document.createElement('div'); nl.className='label'; nl.textContent = label; nb.appendChild(nl);
        const nthumbs = document.createElement('div'); nthumbs.className='thumbs';
        (items || []).forEach(it=>{
          const img = document.createElement('img'); img.className='thumb'; img.src = "../images/" + it.image_url; img.title = `${it.topColor.color_name || ''} ${it.topColor.hex || ''}`; img.addEventListener('click', ()=> openModal(it)); nthumbs.appendChild(img);
        });
        nb.appendChild(nthumbs);
        if(showCount){ const cnt = document.createElement('div'); cnt.className='count'; cnt.textContent = (items||[]).length; nb.appendChild(cnt); }
        return nb;
      };

      histEl.appendChild(makeNeutralBin('white', neutralGroups.white));
      histEl.appendChild(makeNeutralBin('neutral', neutralGroups.neutral));
      histEl.appendChild(makeNeutralBin('black', neutralGroups.black));
    }

    function openModal(item){
      const body = document.getElementById('modalBody'); body.innerHTML = '';
      const img = document.createElement('img'); img.src = "../images/" + item.image_url; body.appendChild(img);
      const p = document.createElement('div'); p.style.marginTop='8px'; p.textContent = `Top color: ${item.topColor.color_name || ''} ${item.topColor.hex || ''} — ${Math.round((item.topColor.proportion||0)*100)}%`;
      body.appendChild(p);
      document.getElementById('modal').style.display='flex';
    }

    // initial build
    build();
  </script>
</body>
</html>
